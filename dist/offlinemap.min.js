!function e(t,n,r){function o(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);throw new Error("Cannot find module '"+s+"'")}var c=n[s]={exports:{}};t[s][0].call(c.exports,function(e){var n=t[s][1][e];return o(n?n:e)},c,c.exports,e,t,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t){(function(e){!function(){function n(e){var t=!1;return function(){if(t)throw new Error("Callback was already called.");t=!0,e.apply(r,arguments)}}var r,o,i={};r=this,null!=r&&(o=r.async),i.noConflict=function(){return r.async=o,i};var s=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===s.call(e)},u=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n+=1)t(e[n],n,e)},c=function(e,t){if(e.map)return e.map(t);var n=[];return u(e,function(e,r,o){n.push(t(e,r,o))}),n},l=function(e,t,n){return e.reduce?e.reduce(t,n):(u(e,function(e,r,o){n=t(n,e,r,o)}),n)},f=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};"undefined"!=typeof e&&e.nextTick?(i.nextTick=e.nextTick,i.setImmediate="undefined"!=typeof setImmediate?function(e){setImmediate(e)}:i.nextTick):"function"==typeof setImmediate?(i.nextTick=function(e){setImmediate(e)},i.setImmediate=i.nextTick):(i.nextTick=function(e){setTimeout(e,0)},i.setImmediate=i.nextTick),i.each=function(e,t,r){function o(t){t?(r(t),r=function(){}):(i+=1,i>=e.length&&r())}if(r=r||function(){},!e.length)return r();var i=0;u(e,function(e){t(e,n(o))})},i.forEach=i.each,i.eachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var r=0,o=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n():o())})};o()},i.forEachSeries=i.eachSeries,i.eachLimit=function(e,t,n,r){var o=h(t);o.apply(null,[e,n,r])},i.forEachLimit=i.eachLimit;var h=function(e){return function(t,n,r){if(r=r||function(){},!t.length||0>=e)return r();var o=0,i=0,s=0;!function a(){if(o>=t.length)return r();for(;e>s&&i<t.length;)i+=1,s+=1,n(t[i-1],function(e){e?(r(e),r=function(){}):(o+=1,s-=1,o>=t.length?r():a())})}()}},p=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[i.each].concat(t))}},d=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[h(e)].concat(n))}},m=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[i.eachSeries].concat(t))}},y=function(e,t,n,r){if(t=c(t,function(e,t){return{index:t,value:e}}),r){var o=[];e(t,function(e,t){n(e.value,function(n,r){o[e.index]=r,t(n)})},function(e){r(e,o)})}else e(t,function(e,t){n(e.value,function(e){t(e)})})};i.map=p(y),i.mapSeries=m(y),i.mapLimit=function(e,t,n,r){return g(t)(e,n,r)};var g=function(e){return d(e,y)};i.reduce=function(e,t,n,r){i.eachSeries(e,function(e,r){n(t,e,function(e,n){t=n,r(e)})},function(e){r(e,t)})},i.inject=i.reduce,i.foldl=i.reduce,i.reduceRight=function(e,t,n,r){var o=c(e,function(e){return e}).reverse();i.reduce(o,t,n,r)},i.foldr=i.reduceRight;var v=function(e,t,n,r){var o=[];t=c(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&o.push(e),t()})},function(){r(c(o.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};i.filter=p(v),i.filterSeries=m(v),i.select=i.filter,i.selectSeries=i.filterSeries;var _=function(e,t,n,r){var o=[];t=c(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||o.push(e),t()})},function(){r(c(o.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};i.reject=p(_),i.rejectSeries=m(_);var b=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(){r()})};i.detect=p(b),i.detectSeries=m(b),i.some=function(e,t,n){i.each(e,function(e,r){t(e,function(e){e&&(n(!0),n=function(){}),r()})},function(){n(!1)})},i.any=i.some,i.every=function(e,t,n){i.each(e,function(e,r){t(e,function(e){e||(n(!1),n=function(){}),r()})},function(){n(!0)})},i.all=i.every,i.sortBy=function(e,t,n){i.map(e,function(e,n){t(e,function(t,r){t?n(t):n(null,{value:e,criteria:r})})},function(e,t){if(e)return n(e);var r=function(e,t){var n=e.criteria,r=t.criteria;return r>n?-1:n>r?1:0};n(null,c(t.sort(r),function(e){return e.value}))})},i.auto=function(e,t){t=t||function(){};var n=f(e),r=n.length;if(!r)return t();var o={},s=[],c=function(e){s.unshift(e)},h=function(e){for(var t=0;t<s.length;t+=1)if(s[t]===e)return s.splice(t,1),void 0},p=function(){r--,u(s.slice(0),function(e){e()})};c(function(){if(!r){var e=t;t=function(){},e(null,o)}}),u(n,function(n){var r=a(e[n])?e[n]:[e[n]],s=function(e){var r=Array.prototype.slice.call(arguments,1);if(r.length<=1&&(r=r[0]),e){var s={};u(f(o),function(e){s[e]=o[e]}),s[n]=r,t(e,s),t=function(){}}else o[n]=r,i.setImmediate(p)},d=r.slice(0,Math.abs(r.length-1))||[],m=function(){return l(d,function(e,t){return e&&o.hasOwnProperty(t)},!0)&&!o.hasOwnProperty(n)};if(m())r[r.length-1](s,o);else{var y=function(){m()&&(h(y),r[r.length-1](s,o))};c(y)}})},i.retry=function(e,t,n){var r=5,o=[];"function"==typeof e&&(n=t,t=e,e=r),e=parseInt(e,10)||r;var s=function(r,s){for(var a=function(e,t){return function(n){e(function(e,r){n(!e||t,{err:e,result:r})},s)}};e;)o.push(a(t,!(e-=1)));i.series(o,function(e,t){t=t[t.length-1],(r||n)(t.err,t.result)})};return n?s():s},i.waterfall=function(e,t){if(t=t||function(){},!a(e)){var n=new Error("First argument to waterfall must be an array of functions");return t(n)}if(!e.length)return t();var r=function(e){return function(n){if(n)t.apply(null,arguments),t=function(){};else{var o=Array.prototype.slice.call(arguments,1),s=e.next();s?o.push(r(s)):o.push(t),i.setImmediate(function(){e.apply(null,o)})}}};r(i.iterator(e))()};var E=function(e,t,n){if(n=n||function(){},a(t))e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(f(t),function(e,n){t[e](function(t){var o=Array.prototype.slice.call(arguments,1);o.length<=1&&(o=o[0]),r[e]=o,n(t)})},function(e){n(e,r)})}};i.parallel=function(e,t){E({map:i.map,each:i.each},e,t)},i.parallelLimit=function(e,t,n){E({map:g(t),each:h(t)},e,n)},i.series=function(e,t){if(t=t||function(){},a(e))i.mapSeries(e,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};i.eachSeries(f(e),function(t,r){e[t](function(e){var o=Array.prototype.slice.call(arguments,1);o.length<=1&&(o=o[0]),n[t]=o,r(e)})},function(e){t(e,n)})}},i.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r};return t(0)},i.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var T=function(e,t,n,r){var o=[];e(t,function(e,t){n(e,function(e,n){o=o.concat(n||[]),t(e)})},function(e){r(e,o)})};i.concat=p(T),i.concatSeries=m(T),i.whilst=function(e,t,n){e()?t(function(r){return r?n(r):(i.whilst(e,t,n),void 0)}):n()},i.doWhilst=function(e,t,n){e(function(r){if(r)return n(r);var o=Array.prototype.slice.call(arguments,1);t.apply(null,o)?i.doWhilst(e,t,n):n()})},i.until=function(e,t,n){e()?n():t(function(r){return r?n(r):(i.until(e,t,n),void 0)})},i.doUntil=function(e,t,n){e(function(r){if(r)return n(r);var o=Array.prototype.slice.call(arguments,1);t.apply(null,o)?n():i.doUntil(e,t,n)})},i.queue=function(e,t){function r(e,t,n,r){return e.started||(e.started=!0),a(t)||(t=[t]),0==t.length?i.setImmediate(function(){e.drain&&e.drain()}):(u(t,function(t){var o={data:t,callback:"function"==typeof r?r:null};n?e.tasks.unshift(o):e.tasks.push(o),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),i.setImmediate(e.process)}),void 0)}void 0===t&&(t=1);var o=0,s={tasks:[],concurrency:t,saturated:null,empty:null,drain:null,started:!1,paused:!1,push:function(e,t){r(s,e,!1,t)},kill:function(){s.drain=null,s.tasks=[]},unshift:function(e,t){r(s,e,!0,t)},process:function(){if(!s.paused&&o<s.concurrency&&s.tasks.length){var t=s.tasks.shift();s.empty&&0===s.tasks.length&&s.empty(),o+=1;var r=function(){o-=1,t.callback&&t.callback.apply(t,arguments),s.drain&&s.tasks.length+o===0&&s.drain(),s.process()},i=n(r);e(t.data,i)}},length:function(){return s.tasks.length},running:function(){return o},idle:function(){return s.tasks.length+o===0},pause:function(){s.paused!==!0&&(s.paused=!0,s.process())},resume:function(){s.paused!==!1&&(s.paused=!1,s.process())}};return s},i.priorityQueue=function(e,t){function n(e,t){return e.priority-t.priority}function r(e,t,n){for(var r=-1,o=e.length-1;o>r;){var i=r+(o-r+1>>>1);n(t,e[i])>=0?r=i:o=i-1}return r}function o(e,t,o,s){return e.started||(e.started=!0),a(t)||(t=[t]),0==t.length?i.setImmediate(function(){e.drain&&e.drain()}):(u(t,function(t){var a={data:t,priority:o,callback:"function"==typeof s?s:null};e.tasks.splice(r(e.tasks,a,n)+1,0,a),e.saturated&&e.tasks.length===e.concurrency&&e.saturated(),i.setImmediate(e.process)}),void 0)}var s=i.queue(e,t);return s.push=function(e,t,n){o(s,e,t,n)},delete s.unshift,s},i.cargo=function(e,t){var n=!1,r=[],o={tasks:r,payload:t,saturated:null,empty:null,drain:null,drained:!0,push:function(e,n){a(e)||(e=[e]),u(e,function(e){r.push({data:e,callback:"function"==typeof n?n:null}),o.drained=!1,o.saturated&&r.length===t&&o.saturated()}),i.setImmediate(o.process)},process:function s(){if(!n){if(0===r.length)return o.drain&&!o.drained&&o.drain(),o.drained=!0,void 0;var i="number"==typeof t?r.splice(0,t):r.splice(0,r.length),a=c(i,function(e){return e.data});o.empty&&o.empty(),n=!0,e(a,function(){n=!1;var e=arguments;u(i,function(t){t.callback&&t.callback.apply(null,e)}),s()})}},length:function(){return r.length},running:function(){return n}};return o};var S=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&u(n,function(t){console[e](t)}))}]))}};i.log=S("log"),i.dir=S("dir"),i.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var o=function(){var o=Array.prototype.slice.call(arguments),s=o.pop(),a=t.apply(null,o);a in n?i.nextTick(function(){s.apply(null,n[a])}):a in r?r[a].push(s):(r[a]=[s],e.apply(null,o.concat([function(){n[a]=arguments;var e=r[a];delete r[a];for(var t=0,o=e.length;o>t;t++)e[t].apply(null,arguments)}])))};return o.memo=n,o.unmemoized=e,o},i.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},i.times=function(e,t,n){for(var r=[],o=0;e>o;o++)r.push(o);return i.map(r,t,n)},i.timesSeries=function(e,t,n){for(var r=[],o=0;e>o;o++)r.push(o);return i.mapSeries(r,t,n)},i.seq=function(){var e=arguments;return function(){var t=this,n=Array.prototype.slice.call(arguments),r=n.pop();i.reduce(e,n,function(e,n,r){n.apply(t,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,n){r.apply(t,[e].concat(n))})}},i.compose=function(){return i.seq.apply(null,Array.prototype.reverse.call(arguments))};var L=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),o=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},o)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};i.applyEach=p(L),i.applyEachSeries=m(L),i.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},"undefined"!=typeof t&&t.exports?t.exports=i:"undefined"!=typeof define&&define.amd?define([],function(){return i}):r.async=i}()}).call(this,e("+xKvab"))},{"+xKvab":2}],2:[function(e,t){function n(){}var r=t.exports={};r.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),n.length>0)){var r=n.shift();r()}},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),r.title="browser",r.browser=!0,r.env={},r.argv=[],r.on=n,r.addListener=n,r.once=n,r.off=n,r.removeListener=n,r.removeAllListeners=n,r.emit=n,r.binding=function(){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(){throw new Error("process.chdir is not supported")}},{}],3:[function(e,t){!function(e,n,r){"function"==typeof define?define(n):"undefined"!=typeof t&&t.exports?t.exports=n():r[e]=n()}("IDBStore",function(){"use strict";var e=function(e){throw e},t={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:e,indexes:[]},n=function(e,n){"undefined"==typeof n&&"function"==typeof e&&(n=e),"[object Object]"!=Object.prototype.toString.call(e)&&(e={});for(var r in t)this[r]="undefined"!=typeof e[r]?e[r]:t[r];this.dbName=this.storePrefix+this.storeName,this.dbVersion=parseInt(this.dbVersion,10)||1,n&&(this.onStoreReady=n);var o="object"==typeof window?window:self;this.idb=o.indexedDB||o.webkitIndexedDB||o.mozIndexedDB,this.keyRange=o.IDBKeyRange||o.webkitIDBKeyRange||o.mozIDBKeyRange,this.features={hasAutoIncrement:!o.mozIndexedDB},this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"},this.openDB()};n.prototype={constructor:n,version:"1.4.1",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){var e=this.idb.open(this.dbName,this.dbVersion),t=!1;e.onerror=function(e){var t=!1;"error"in e.target?t="VersionError"==e.target.error.name:"errorCode"in e.target&&(t=12==e.target.errorCode),t?this.onError(new Error("The version number provided is lower than the existing one.")):this.onError(e)}.bind(this),e.onsuccess=function(e){if(!t){if(this.db)return this.onStoreReady(),void 0;if(this.db=e.target.result,"string"==typeof this.db.version)return this.onError(new Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser.")),void 0;if(!this.db.objectStoreNames.contains(this.storeName))return this.onError(new Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser.")),void 0;var n=this.db.transaction([this.storeName],this.consts.READ_ONLY);this.store=n.objectStore(this.storeName);var r=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var n=e.name;if(!n)return t=!0,this.onError(new Error("Cannot create index: No index name given.")),void 0;if(this.normalizeIndexData(e),this.hasIndex(n)){var o=this.store.index(n),i=this.indexComplies(o,e);i||(t=!0,this.onError(new Error('Cannot modify index "'+n+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),r.splice(r.indexOf(n),1)}else t=!0,this.onError(new Error('Cannot create new index "'+n+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))},this),r.length&&(t=!0,this.onError(new Error('Cannot delete index(es) "'+r.toString()+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))),t||this.onStoreReady()}}.bind(this),e.onupgradeneeded=function(e){if(this.db=e.target.result,this.db.objectStoreNames.contains(this.storeName))this.store=e.target.transaction.objectStore(this.storeName);else{var n={autoIncrement:this.autoIncrement};null!==this.keyPath&&(n.keyPath=this.keyPath),this.store=this.db.createObjectStore(this.storeName,n)}var r=Array.prototype.slice.call(this.getIndexList());this.indexes.forEach(function(e){var n=e.name;if(n||(t=!0,this.onError(new Error("Cannot create index: No index name given."))),this.normalizeIndexData(e),this.hasIndex(n)){var o=this.store.index(n),i=this.indexComplies(o,e);i||(this.store.deleteIndex(n),this.store.createIndex(n,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})),r.splice(r.indexOf(n),1)}else this.store.createIndex(n,e.keyPath,{unique:e.unique,multiEntry:e.multiEntry})},this),r.length&&r.forEach(function(e){this.store.deleteIndex(e)},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)},put:function(t,n,o,i){null!==this.keyPath&&(i=o,o=n,n=t),i||(i=e),o||(o=r);var s,a=!1,u=null,c=this.db.transaction([this.storeName],this.consts.READ_WRITE);return c.oncomplete=function(){var e=a?o:i;e(u)},c.onabort=i,c.onerror=i,null!==this.keyPath?(this._addIdPropertyIfNeeded(n),s=c.objectStore(this.storeName).put(n)):s=c.objectStore(this.storeName).put(n,t),s.onsuccess=function(e){a=!0,u=e.target.result},s.onerror=i,c},get:function(t,n,o){o||(o=e),n||(n=r);var i=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_ONLY);a.oncomplete=function(){var e=i?n:o;e(s)},a.onabort=o,a.onerror=o;var u=a.objectStore(this.storeName).get(t);return u.onsuccess=function(e){i=!0,s=e.target.result},u.onerror=o,a},remove:function(t,n,o){o||(o=e),n||(n=r);var i=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_WRITE);a.oncomplete=function(){var e=i?n:o;e(s)},a.onabort=o,a.onerror=o;var u=a.objectStore(this.storeName)["delete"](t);return u.onsuccess=function(e){i=!0,s=e.target.result},u.onerror=o,a},batch:function(t,n,o){o||(o=e),n||(n=r),"[object Array]"!=Object.prototype.toString.call(t)&&o(new Error("dataArray argument must be of type Array."));var i=this.db.transaction([this.storeName],this.consts.READ_WRITE);i.oncomplete=function(){var e=u?n:o;e(u)},i.onabort=o,i.onerror=o;var s=t.length,a=!1,u=!1,c=function(){s--,0!==s||a||(a=!0,u=!0)};return t.forEach(function(e){var t=e.type,n=e.key,r=e.value,s=function(e){i.abort(),a||(a=!0,o(e,t,n))};if("remove"==t){var u=i.objectStore(this.storeName)["delete"](n);u.onsuccess=c,u.onerror=s}else if("put"==t){var l;null!==this.keyPath?(this._addIdPropertyIfNeeded(r),l=i.objectStore(this.storeName).put(r)):l=i.objectStore(this.storeName).put(r,n),l.onsuccess=c,l.onerror=s}},this),i},putBatch:function(e,t,n){var r=e.map(function(e){return{type:"put",value:e}});return this.batch(r,t,n)},removeBatch:function(e,t,n){var r=e.map(function(e){return{type:"remove",key:e}});return this.batch(r,t,n)},getBatch:function(t,n,o,i){o||(o=e),n||(n=r),i||(i="sparse"),"[object Array]"!=Object.prototype.toString.call(t)&&o(new Error("keyArray argument must be of type Array."));var s=this.db.transaction([this.storeName],this.consts.READ_ONLY);s.oncomplete=function(){var e=l?n:o;e(f)},s.onabort=o,s.onerror=o;var a=[],u=t.length,c=!1,l=!1,f=null,h=function(e){e.target.result||"dense"==i?a.push(e.target.result):"sparse"==i&&a.length++,u--,0===u&&(c=!0,l=!0,f=a)};return t.forEach(function(e){var t=function(e){c=!0,f=e,o(e),s.abort()},n=s.objectStore(this.storeName).get(e);n.onsuccess=h,n.onerror=t},this),s},getAll:function(t,n){n||(n=e),t||(t=r);var o=this.db.transaction([this.storeName],this.consts.READ_ONLY),i=o.objectStore(this.storeName);return i.getAll?this._getAllNative(o,i,t,n):this._getAllCursor(o,i,t,n),o},_getAllNative:function(e,t,n,r){var o=!1,i=null;e.oncomplete=function(){var e=o?n:r;e(i)},e.onabort=r,e.onerror=r;var s=t.getAll();s.onsuccess=function(e){o=!0,i=e.target.result},s.onerror=r},_getAllCursor:function(e,t,n,r){var o=[],i=!1,s=null;e.oncomplete=function(){var e=i?n:r;e(s)},e.onabort=r,e.onerror=r;var a=t.openCursor();a.onsuccess=function(e){var t=e.target.result;t?(o.push(t.value),t["continue"]()):(i=!0,s=o)},a.onError=r},clear:function(t,n){n||(n=e),t||(t=r);var o=!1,i=null,s=this.db.transaction([this.storeName],this.consts.READ_WRITE);s.oncomplete=function(){var e=o?t:n;e(i)},s.onabort=n,s.onerror=n;var a=s.objectStore(this.storeName).clear();return a.onsuccess=function(e){o=!0,i=e.target.result},a.onerror=n,s},_addIdPropertyIfNeeded:function(e){this.features.hasAutoIncrement||"undefined"!=typeof e[this.keyPath]||(e[this.keyPath]=this._insertIdCount++ +Date.now())},getIndexList:function(){return this.store.indexNames},hasIndex:function(e){return this.store.indexNames.contains(e)},normalizeIndexData:function(e){e.keyPath=e.keyPath||e.name,e.unique=!!e.unique,e.multiEntry=!!e.multiEntry},indexComplies:function(e,t){var n=["keyPath","unique","multiEntry"].every(function(n){if("multiEntry"==n&&void 0===e[n]&&t[n]===!1)return!0;if("keyPath"==n&&"[object Array]"==Object.prototype.toString.call(t[n])){var r=t.keyPath,o=e.keyPath;if("string"==typeof o)return r.toString()==o;if("function"!=typeof o.contains&&"function"!=typeof o.indexOf)return!1;if(o.length!==r.length)return!1;for(var i=0,s=r.length;s>i;i++)if(!(o.contains&&o.contains(r[i])||o.indexOf(-1!==r[i])))return!1;return!0}return t[n]==e[n]});return n},iterate:function(t,n){n=i({index:null,order:"ASC",autoContinue:!0,filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:e},n||{});var r="desc"==n.order.toLowerCase()?"PREV":"NEXT";n.filterDuplicates&&(r+="_NO_DUPLICATE");var o=!1,s=this.db.transaction([this.storeName],this.consts[n.writeAccess?"READ_WRITE":"READ_ONLY"]),a=s.objectStore(this.storeName);n.index&&(a=a.index(n.index)),s.oncomplete=function(){return o?(n.onEnd?n.onEnd():t(null),void 0):(n.onError(null),void 0)},s.onabort=n.onError,s.onerror=n.onError;var u=a.openCursor(n.keyRange,this.consts[r]);return u.onerror=n.onError,u.onsuccess=function(e){var r=e.target.result;r?(t(r.value,r,s),n.autoContinue&&r["continue"]()):o=!0},s},query:function(e,t){var n=[];return t=t||{},t.onEnd=function(){e(n)},this.iterate(function(e){n.push(e)},t)},count:function(t,n){n=i({index:null,keyRange:null},n||{});var r=n.onError||e,o=!1,s=null,a=this.db.transaction([this.storeName],this.consts.READ_ONLY);a.oncomplete=function(){var e=o?t:r;e(s)},a.onabort=r,a.onerror=r;var u=a.objectStore(this.storeName);n.index&&(u=u.index(n.index));var c=u.count(n.keyRange);return c.onsuccess=function(e){o=!0,s=e.target.result},c.onError=r,a},makeKeyRange:function(e){var t,n="undefined"!=typeof e.lower,r="undefined"!=typeof e.upper,o="undefined"!=typeof e.only;switch(!0){case o:t=this.keyRange.only(e.only);break;case n&&r:t=this.keyRange.bound(e.lower,e.upper,e.excludeLower,e.excludeUpper);break;case n:t=this.keyRange.lowerBound(e.lower,e.excludeLower);break;case r:t=this.keyRange.upperBound(e.upper,e.excludeUpper);break;default:throw new Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value, or an "only" value.')}return t}};var r=function(){},o={},i=function(e,t){var n,r;for(n in t)r=t[n],r!==o[n]&&r!==e[n]&&(e[n]=r);return e};return n.version=n.prototype.version,n},this)},{}],4:[function(e,t){var n,r,o;t.exports=n=function(){function e(e){this.offlineLayer=e}return e.prototype.retrieveImage=function(e,t,n){var i;return i=this.offlineLayer._createURL(e.x,e.y,e.z),r(i,function(e){return t(o(e))},n)},e}(),r=function(e,t,n){var r;return r=new XMLHttpRequest,r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(e){return 200===this.status?t(this.response):n("GET_STATUS_ERROR",e)},r.onerror=function(e){return n("NETWORK_ERROR",e)},r.send()},o=function(e){var t,n,r,o,i;for(t="",n=new Uint8Array(e),r=o=0,i=n.byteLength;i>=0?i>o:o>i;r=i>=0?++o:--o)t+=String.fromCharCode(n[r]);return"data:image/png;base64,"+btoa(t)}},{}],5:[function(e,t){var n,r,o,i;i=e("async"),r=e("./IndexedDBDataStorage"),o=e("./WebSQLDataStorage"),t.exports=n=function(){function e(e,t){if(null==t)throw new Error("the image store needs an imageRetriever");if(null==e)throw new Error("the image store needs an eventEmitter");this._eventEmitter=e,this._nbTilesLeftToSave=0,this._nbImagesCurrentlyBeingRetrieved=0,this._imageRetriever=t,this._myQueue=null,this._beingCanceled=!1,this._running=!1}return e.prototype.createDB=function(e,t,n,i){var s;if(s=i,null==t)throw new Error("This async function needs a callback");return this.storage=s?new o(e,t,n):new r(e,t,n)},e.prototype.cancel=function(){return this._running?this._beingCanceled?!0:(this._beingCanceled=!0,null!=this._myQueue?(this._myQueue.kill(),0===this._nbImagesCurrentlyBeingRetrieved&&this._finish(),!0):!1):!1},e.prototype.isBusy=function(){return this._running},e.prototype.get=function(e,t,n){if(null==t||null==n)throw new Error("This async function needs callbacks");return this.storage.get(e,t,n)},e.prototype.clear=function(e,t){if(null==e||null==t)throw new Error("This async function needs callbacks");return this.storage.clear(e,t)},e.prototype._finish=function(e,t){return this._running=!1,this._beingCanceled=!1,this._eventEmitter.fire("tilecachingprogressdone",null),this._myQueue=null,this._nbImagesCurrentlyBeingRetrieved=0,null!=e?t(e):this._onSaveImagesSuccess()},e.prototype.saveImages=function(e,t,n,r){if(this._running=!0,null!=this._myQueue)throw new Error("Not allowed to save images while saving is already in progress");if(null==t||null==n||null==r)throw new Error("This async function needs callbacks");return this._onSaveImagesSuccess=n,this._getImagesNotInDB(e,function(e){return function(n){var o,s,a,u;if(!e._beingCanceled&&null!=n&&n.length>0){for(o=8,e._myQueue=i.queue(function(t,n){return e._saveTile(t,n)},o),e._myQueue.drain=function(t){return e._finish(t,r)},a=0,u=n.length;u>a;a++)s=n[a],e._myQueue.push(s);return t()}return t(),e._finish()}}(this),function(e){return r(e)})},e.prototype._getImagesNotInDB=function(e,t,n){var r,o;o=[];for(r in e)o.push(r);return this.storage.getDenseBatch(o,function(n){return function(r){var i,s,a,u,c,l;for(i=0,u=[],n._eventEmitter.fire("tilecachingstart",null),n._nbTilesLeftToSave=0,s=function(t){var r,s;return t||(r=o[i],s=e[r],n._nbTilesLeftToSave++,u.push({key:r,tileInfo:s})),i++},c=0,l=r.length;l>c;c++)a=r[c],s(a);return n._updateTotalNbImagesLeftToSave(n._nbTilesLeftToSave),t(u)}}(this),function(e){return n(e)})},e.prototype._saveTile=function(e,t){var n,r;return r=function(n){return function(r){return n.storage.put(e.key,{image:r},function(){return n._decrementNbTilesLeftToSave(),t()},function(e){return n._decrementNbTilesLeftToSave(),t(e)})}}(this),n=function(n){return function(r,o){return n._decrementNbTilesLeftToSave(),n._eventEmitter._reportError(r,{data:o,tileInfo:e.tileInfo}),t(r)}}(this),this._nbImagesCurrentlyBeingRetrieved++,this._imageRetriever.retrieveImage(e.tileInfo,r,n)},e.prototype._updateTotalNbImagesLeftToSave=function(e){return this._nbTilesLeftToSave=e,this._eventEmitter.fire("tilecachingprogressstart",{nbTiles:this._nbTilesLeftToSave})},e.prototype._decrementNbTilesLeftToSave=function(){return this._nbTilesLeftToSave--,this._beingCanceled||this._eventEmitter.fire("tilecachingprogress",{nbTiles:this._nbTilesLeftToSave}),this._nbImagesCurrentlyBeingRetrieved--,this._beingCanceled&&0===this._nbImagesCurrentlyBeingRetrieved?this._finish():void 0},e}()},{"./IndexedDBDataStorage":6,"./WebSQLDataStorage":9,async:1}],6:[function(e,t){var n,r;n=e("idb-wrapper"),t.exports=r=function(){function e(e,t,r){this._idbStore=new n({dbVersion:1,storeName:e,keyPath:null,autoIncrement:!1},t,r)}return e.prototype.get=function(e,t,n){return this._idbStore.get(e,t,n)},e.prototype.clear=function(e,t){return this._idbStore.clear(e,t)},e.prototype.put=function(e,t,n,r){return this._idbStore.put(e,t,n,r)},e.prototype.getDenseBatch=function(e,t,n){return this._idbStore.getBatch(e,t,n,"dense")},e}()},{"idb-wrapper":3}],7:[function(e,t){var n,r,o,i={}.hasOwnProperty,s=function(e,t){function n(){this.constructor=e}for(var r in t)i.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};r=e("./ImageStore"),n=e("./ImageRetriever"),t.exports=o=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return s(t,e),t.prototype.initialize=function(e,t){var o,i,s,a,u;if(L.TileLayer.prototype.initialize.call(this,e,t),this._map=t.map,this._onReady=t.onReady,this._onError=t.onError,o=t.dbOption,this._dbOnly=t.dbOnly,a=t.storeName||"OfflineLeafletTileImages",this._tileImagesStore=null,this._minZoomLevel=12,null!=t.minZoomLevel&&(this._minZoomLevel=parseInt(t.minZoomLevel)),null==o||"None"===o)return setTimeout(function(e){return function(){return e._onReady()}}(this),0);try{return"WebSQL"===o?u=!0:"IndexedDB"===o?u=!1:this._onError("COULD_NOT_CREATE_DB","Invalid dbOption parameter: "+o),s=new n(this),this._tileImagesStore=new r(this,s),this._tileImagesStore.createDB(a,function(e){return function(){return e._onReady()}}(this),function(e){return function(t){return e._tileImagesStore=null,e._reportError("COULD_NOT_CREATE_DB",t),setTimeout(function(){return e._onReady()},0)}}(this),u)}catch(c){return i=c,this._tileImagesStore=null,this._reportError("COULD_NOT_CREATE_DB",i),setTimeout(function(e){return function(){return e._onReady()}}(this),0)}},t.prototype._setUpTile=function(e,t,n){return e.src=n,this.fire("tileloadstart",{tile:e,url:e.src})},t.prototype._reportError=function(e,t){return this._onError?this._onError(e,t):void 0},t.prototype._loadTile=function(e,t){var n,r,o;return!this._dbOnly==!0&&(this._dbOnly=!1),this._tileImagesStore?(e._layer=this,e.onerror=this._tileOnError,this._adjustTilePoint(t),e.onload=this._tileOnLoad,o=function(r){return function(o){return o?r._setUpTile(e,n,o.image):r._dbOnly?void 0:r._setUpTile(e,n,r.getTileUrl(t))}}(this),r=function(r){return function(){return r._dbOnly||r._setUpTile(e,n,r.getTileUrl(t)),r._reportError("DB_GET",n)}}(this),n=this._createTileKey(t.x,t.y,t.z),this._tileImagesStore.get(n,o,r)):L.TileLayer.prototype._loadTile.call(this,e,t)},t.prototype.useDB=function(){return null!==this._tileImagesStore},t.prototype.cancel=function(){return null!=this._tileImagesStore?this._tileImagesStore.cancel():!1},t.prototype.clearTiles=function(e,t){return this.useDB()?this.isBusy()?(this._reportError("SYSTEM_BUSY","System is busy."),t("System is busy."),void 0):this._tileImagesStore.clear(e,function(e){return function(n){return e._reportError("COULD_NOT_CLEAR_DB",n),t(n)}}(this)):(this._reportError("NO_DB","No DB available"),t("No DB available"),void 0)},t.prototype.calculateNbTiles=function(e,t){var n,r,o;if(this._map.getZoom()<this._minZoomLevel)return this._reportError("ZOOM_LEVEL_TOO_LOW"),-1;n=0,o=t?this._getTilesByRegion(e,t):this._getTileImages(e);for(r in o)n++;return n},t.prototype.isBusy=function(){return null!=this._tileImagesStore?this._tileImagesStore.isBusy():!1},t.prototype._getTileImages=function(e){var t,n,r,o,i,s,a,u,c,l,f,h,p,d,m,y,g,v,_,b,E,T,S,I,x;for(e=e||this._map.getMaxZoom(),d={},i=this._map,h=i.getZoom(),n=i.getPixelBounds(),m=this._getTileSize(),f=L.bounds(n.min.divideBy(m)._floor(),n.max.divideBy(m)._floor()),y=[],o=_=T=f.min.y,S=f.max.y;S>=T?S>=_:_>=S;o=S>=T?++_:--_)for(r=b=I=f.min.x,x=f.max.x;x>=I?x>=b:b>=x;r=x>=I?++b:--b)y.push(new L.Point(r,o));for(p=L.bounds(n.min.divideBy(m),n.max.divideBy(m)),c=p.min.y,a=p.max.y,u=p.min.x,s=p.max.x,t=y.length,r=E=0;t>=0?t>E:E>t;r=t>=0?++E:--E)l=y[r],g=l.x,v=l.y,this._getZoomedInTiles(g,v,h,e,d,c,a,u,s),this._getZoomedOutTiles(g,v,h,0,d,c,a,u,s);return d},t.prototype.saveTiles=function(e,t,n,r){var o;return this._tileImagesStore?this.isBusy()?(this._reportError("SYSTEM_BUSY","system is busy."),r("system is busy."),void 0):this._map.getZoom()<this._minZoomLevel?(this._reportError("ZOOM_LEVEL_TOO_LOW"),r("ZOOM_LEVEL_TOO_LOW"),void 0):(o=this._getTileImages(e),this._tileImagesStore.saveImages(o,t,n,function(e){return function(t){return e._reportError("SAVING_TILES",t),r(t)}}(this))):(this._reportError("NO_DB","No DB available"),r("No DB available"),void 0)},t.prototype._getTilesByRegion=function(e,t){var n,r,o,i,s,a,u,c,l,f,h,p,d,m,y,g,v,_,b,E,T,S,I,x,w,N,O,B,R,k,D,A;for(console.log("[_getTilesByRegion()]"),e=e||this._map.getMaxZoom(),g=12,b={},E=this._getTileSize(),o=this._map.getPixel,x=0,B=t.length;B>x;x++){for(m=t[x],console.log("[_getTilesByRegion()] Processing "+m.name),v=L.latLng(m.sLat,m.wLng),f=L.latLng(m.nLat,m.eLng),d=L.point(this._map.project(v,g).x,this._map.project(v,g).y),h=L.point(this._map.project(f,g).x,this._map.project(f,g).y),r=L.bounds(d,h),y=L.bounds(r.min.divideBy(E)._floor(),r.max.divideBy(E)._floor()),console.log("[_getTilesByRegion()] roundedTileBounds"),console.log(y.min),console.log(y.max),T=[],s=w=R=y.min.y,k=y.max.y;k>=R?k>=w:w>=k;s=k>=R?++w:--w)for(i=N=D=y.min.x,A=y.max.x;A>=D?A>=N:N>=A;i=A>=D?++N:--N)T.push(new L.Point(i,s));
for(_=L.bounds(r.min.divideBy(E),r.max.divideBy(E)),l=_.min.y,u=_.max.y,c=_.min.x,a=_.max.x,n=T.length,console.log("[_getTilesByRegion()] arrayLength = "+n),i=O=0;n>=0?n>O:O>n;i=n>=0?++O:--O)p=T[i],S=p.x,I=p.y,this._getZoomedInTiles(S,I,g,e,b,l,u,c,a),this._getZoomedOutTiles(S,I,g,0,b,l,u,c,a)}return b},t.prototype.saveRegions=function(e,t,n,r,o){var i;return console.log("[saveRegions()]"),this._tileImagesStore?this.isBusy()?(this._reportError("SYSTEM_BUSY","system is busy."),o("system is busy."),void 0):this._map.getZoom()<this._minZoomLevel?(this._reportError("ZOOM_LEVEL_TOO_LOW"),o("ZOOM_LEVEL_TOO_LOW"),void 0):(i=this._getTilesByRegion(t,e),console.log("[saveRegions] tileImagesToQuery"),console.log(i),this._tileImagesStore.saveImages(i,n,r,function(e){return function(t){return e._reportError("SAVING_TILES",t),o(t)}}(this))):(this._reportError("NO_DB","No DB available"),o("No DB available"),void 0)},t.prototype._getZoomedInTiles=function(e,t,n,r,o,i,s,a,u){return this._getTileImage(e,t,n,o,i,s,a,u,!0),r>n?(i*=2,s*=2,a*=2,u*=2,this._getZoomedInTiles(2*e,2*t,n+1,r,o,i,s,a,u),this._getZoomedInTiles(2*e+1,2*t,n+1,r,o,i,s,a,u),this._getZoomedInTiles(2*e,2*t+1,n+1,r,o,i,s,a,u),this._getZoomedInTiles(2*e+1,2*t+1,n+1,r,o,i,s,a,u)):void 0},t.prototype._getZoomedOutTiles=function(e,t,n,r,o,i,s,a,u){return this._getTileImage(e,t,n,o,i,s,a,u,!1),n>r?(i/=2,s/=2,a/=2,u/=2,this._getZoomedOutTiles(Math.floor(e/2),Math.floor(t/2),n-1,r,o,i,s,a,u)):void 0},t.prototype._getTileImage=function(e,t,n,r,o,i,s,a){var u;if(!(e<Math.floor(s)||e>Math.floor(a)||t<Math.floor(o)||t>Math.floor(i)))return u=this._createTileKey(e,t,n),r[u]?void 0:r[u]={key:u,x:e,y:t,z:n}},t.prototype._createNormalizedTilePoint=function(e,t,n){var r;for(r=Math.pow(2,n);e>r;)e-=r;for(;0>e;)e+=r;for(;t>r;)t-=r;for(;0>t;)t+=r;return{x:e,y:t,z:n}},t.prototype._createURL=function(e,t,n){var r;return r=this._createNormalizedTilePoint(e,t,n),this.getTileUrl(r)},t.prototype._createTileKey=function(e,t,n){var r;return r=this._createNormalizedTilePoint(e,t,n),r.x+", "+r.y+", "+r.z},t}(L.TileLayer)},{"./ImageRetriever":4,"./ImageStore":5}],8:[function(e,t){var n,r={}.hasOwnProperty,o=function(e,t){function n(){this.constructor=e}for(var o in t)r.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e};t.exports=n=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return o(t,e),t.prototype.onAdd=function(){var e;return e=L.DomUtil.create("div","offlinemap-controls",this._container),e.setAttribute("id","offlinemap-controls"),this._counter=L.DomUtil.create("div","offlinemap-controls-counter",e),this._counter.setAttribute("id","offlinemap-controls-counter"),this._counter.innerHTML="Ready",this._cancelButton=L.DomUtil.create("input","offlinemap-controls-cancel-button",e),this._cancelButton.setAttribute("type","button"),this._cancelButton.setAttribute("id","cancelBtn"),this._cancelButton.setAttribute("value","Cancel"),this._cancelButton.setAttribute("disabled",!0),L.DomEvent.addListener(this._cancelButton,"click",this.onCancelClick,this),L.DomEvent.disableClickPropagation(this._cancelButton),e},t.prototype.onProgressStart=function(){return this._evaluating=!0,this._counter.innerHTML="...",this._cancelButton.removeAttribute("disabled")},t.prototype.onProgressDone=function(){return this._counter.innerHTML="Ready",this._cancelButton.removeAttribute("disabled")},t.prototype.updateTotalNbTilesLeftToSave=function(e){return this._evaluating=!1,this._nbTilesToSave=e.nbTiles,this.updateNbTilesLeftToSave(e)},t.prototype.updateNbTilesLeftToSave=function(e){return this._evaluating?void 0:this._counter.innerHTML=0===this._nbTilesToSave?"100%":Math.floor((this._nbTilesToSave-e.nbTiles)/this._nbTilesToSave*100)+"%"},t.prototype.onCancelClick=function(){return this._offlineLayer.cancel()?(this._counter.innerHTML="Canceling...",this._cancelButton.setAttribute("disabled",!0)):void 0},t.prototype.setOfflineLayer=function(e){return this._offlineLayer=e,this._offlineLayer.on("tilecachingstart",this.onProgressStart,this),this._offlineLayer.on("tilecachingprogressstart",this.updateTotalNbTilesLeftToSave,this),this._offlineLayer.on("tilecachingprogress",this.updateNbTilesLeftToSave,this),this._offlineLayer.on("tilecachingprogressdone",this.onProgressDone,this)},t}(L.Control)},{}],9:[function(e,t){var n;t.exports=n=function(){function e(e,t,n){this._storeName=e,this._webSQLDB=openDatabase("OfflineTileImages","1.0","Store tile images for OfflineLeaftMap",52428800),this._webSQLDB.transaction(function(e){return function(t){return t.executeSql("CREATE TABLE IF NOT EXISTS "+e._storeName+" (key unique, image)")}}(this),n,t)}return e.prototype.get=function(e,t,n){return this._webSQLDB.transaction(function(r){return function(o){var i;return i=function(e,r){var o;return o=r.rows.length,0===o?t(void 0):1===o?t(r.rows.item(0)):n("There should be no more than one entry")},o.executeSql("SELECT * FROM "+r._storeName+" WHERE key='"+e+"'",[],i,n)}}(this))},e.prototype.clear=function(e,t){return this._webSQLDB.transaction(function(n){return function(r){return r.executeSql("DELETE FROM "+n._storeName,[],e,t)}}(this))},e.prototype.put=function(e,t,n,r){return this._webSQLDB.transaction(function(o){return function(i){return i.executeSql("INSERT OR REPLACE INTO "+o._storeName+" VALUES (?, ?)",[e,t.image],n,r)}}(this))},e.prototype.getDenseBatch=function(e,t,n){return 0===e.length&&t([]),this._webSQLDB.transaction(function(r){return function(o){var i,s,a,u,c,l,f;for(u=[],c=[],i=l=0,f=e.length;f>=0?f>l:l>f;i=f>=0?++l:--l)c.push("'"+e[i]+"'"),u.push(void 0);return s=c.join(","),a=function(n,r){var o,s,a,c;for(i=a=0,c=r.rows.length;c>=0?c>a:a>c;i=c>=0?++a:--a)s=r.rows.item(i),o=e.indexOf(s.key),o>=0&&(u[o]=s);return t(u)},o.executeSql("SELECT * FROM "+r._storeName+" WHERE key IN ("+s+")",[],a,n)}}(this))},e}()},{}],10:[function(e){window.OfflineLayer=e("./OfflineLayer"),window.OfflineProgressControl=e("./OfflineProgressControl")},{"./OfflineLayer":7,"./OfflineProgressControl":8}]},{},[10]);